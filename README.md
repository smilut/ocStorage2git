# ocStorage2git
скрипт выгрузки истории разработки из хранилища конфигурации 1С в git

Требования.

База 1С не подключенная к хранилищу конфигураций, для загрузки требуемых версий конфигурации из хранилища. 
Подключенная к хранилищу база позволяет загружать только текущую версию.
База содержит пустую конфигурацию базы данных, никогда основная конфигурация, загруженная из хранилища, 
не сохраняется в конфигурацию базы данных. 
Это необходимо для запуска пустой конфигурации в пакетном режиме и выполнения сервисных обработок.
В конфигурации, которая сохранена в базе данных, должна присутствовать роль ПолныеПрава и пользователь
с этой ролью и отключенной защитой от опасных действий. 
Под этим пользователем будет выполняться обработка парсинга отчета хранилища.
Запуск конфигуратора 1С в пакетном режиме с подключением к созданной в п.1 базе должен выполняться без ошибок.

Ограничения.

При перезаливке конфигурации в хранилище версия хранилища сбрасывается на 1(единицу). 
Что может привести к ошибкам в работе скрипта формирования хронологии в Git.

Сценарий использования, создания истории в Git.

Исходные данные:
	Пустая база 1С. Хранилище с историей разработки.
	
Действия скрипта:

1. Получает  отчет по хранилищу по новой версии, начиная с 1 версии (или с указанной если это не первый запуск)
2. Конвертирует отчет хранилища в json для обработки скриптом.
3. Начинает цикл обработки версий хранилища:
 
-Обновляет базу из хранилища, на минимальную не обработанную версию

-Выгружает файлы конфигурации в папку проекта git, с учетом авторства, даты и комментария к версии хранилища

-Выполняет git add

-Выполняет commit от имени пользователя создавшего версию в хранилище. 
  В качестве описания коммитов для краткости используется комментарий версии, 
  для полного описания список измененных объектов.
  
-Переходит к обработке следующей версии

4. Скрипт завершается либо по ошибке, либо обработав все версии полученные в отчете. 
    Номер, на котором прервалась обработка запоминается, как начальный номер для следующего запуска.

# config.json
{  
	"description": -- секция для ввода комментариев  
	"onec": { -- секция описания настроек запуска 1С    
		"start_path": "C:\\Program Files\\1cv8\\8.3.20.1838\\bin\\1cv8.exe",  
		"report_convert_processor_path": -- путь к обработке преобразующей отчет по хранлищу из .mxl в .json, например "C:\\projects\\StorageToGit\\ОтчетПоХранилищуВjson.epf",  
		"result_dump_path": -- путь к файлу вывода из командной строки по ключу /DumpResult, например "C:\\projects\\StorageToGit\\tests\\test data\\result.txt",  
		"log_file_path": -- путь к файлу вывода из командной строки по ключу /out, например "C:\\projects\\StorageToGit\\tests\\test data\\out.txt",  
		"timeout": -- таймаут используемый при вызове 1С, если в для команды не предназначена другая настройка таймаута,  
		"update_timeout": -- таймаут обновления конфигурации из хранилища,  
		"dump_timeout": -- таймаут выгрузки конфигурации в файлы  
	},  
	"storage": { -- секция настроек работы с хранилищем  
		"path": -- путь хранилищу локальный или сетевой,  
		"user": -- пользователь хранилища,  
		"password": -- пароль пользователя хранилища,  
		"report_path": -- путь к файлу, в который сохраняется отчет по хранилищу,  
		"json_report_path": -- путь к файлу, в который сохраняется результат преобразования отчета по хранилищу,  
		"authors": [ -- секция описания пользователей хранилища, для связки логина хранилища и email    
			{  
				"user": "Администратор",  
				"email": "admin@test.com"  
			},  
			{  
				"user": "ReadOnle",  
				"email": "readonly@readonly.com"  
			}  
		],  
		"version_path": -- путь к файлу, в который сохраняется номер последней обработанной скриптом версии,  
	},  
	"info_base": { -- секция настроек информационной базы, через которую будет выполняться выгрузка из хранилища в git   
		"connection_string": -- строка соединения, как она видна в стартовом окне 1С, например "File=\"C:\\projects\\StorageToGit\\tests\\test data\\StorageReceiver\";",    
		"user": "Администратор",  
		"password": "",  
		"windows_auth": -- если данный флаг == true, то "user" и "password" игнорируются  
	},  
	"git": { -- секция насроек работы с git 
		"path": -- путь к локальному репозиторию, например "C:\\projects\\StorageToGit\\tests\\test data\\test_repo\\conf_src",  
		"configuration_src_path": -- путь к папке, в которую будет выгружена конфигурация. Данная папка может быть вложенной по отношению к папке репозитория, например "C:\\projects\\StorageToGit\\tests\\test data\\test_repo\\conf_src\\src", или совпадать с папкой репозитрия, например "C:\\projects\\StorageToGit\\tests\\test data\\test_repo\\conf_src"  
		"default_user_email": -- арес присваиваемый пользователю внесшему изменения в хранилище, если пользователь отсутствует в секции storage\authors, например "defuser@mail.dev", необходим т.к. git не выболняет commit без указания email автора  
		"push_timeout": -- таймаут выполнения git push,  
		"commit_msg_prefix": -- префикс подставляемый в строку описания коммита,    
		"push_time": -- время, после которого выполняется git push, например "20:00", игнорируется если установлен флаг script\push_after_convertation      
	},  
	"logging": { -- секция настроек логирования, подробности в документации модуля python logging    
		"level": "DEBUG",    
		"path": -- путь сохранения лога работы скрипта,    
		"rotate_time": "midnight",  
		"rotate_interval": 1, -- в случае "rotate_time": "midnight", данный параметр игнорируется    
		"copy_count": 5  
	},  
	"script": { -- секция общих настроек скрипта   
		"terminate": -- флаг прерывания работы скрипта после указанного времени,    
		"terminate_after": -- время, после которого необходимо остановить скрипт, при первой возможности, например "10:00",    
		"push_after_convertation": -- флаг необходимости выполнить git push перед остановкой скрипта    
	}  
}
# tests\config.json
Тесты разрабатывались с использованием файловой базы данных.  
  
{  
	"script_config_path": -- путь к файлу настроек основного скрипта, например "C:\\projects\\StorageToGit\\config.json",  
	"empty_dt_path": -- путь к файлу выгрузки исходной базы данных, в которую загружаются данные из хранилища. Данная выгрузка может быть использована для настройки продуктивной базы выгрузки данных хранилища в git. Например "C:\\projects\\StorageToGit\\tests\\empty_1Cv8.dt",    
	"data_path": -- папка хранения данных формируемых в процессе выполнения тестов. Полностью удаляется при запуске нового цикла тестирования. Например "C:\\projects\\StorageToGit\\tests\\test data\\",  
	"base_name": -- имя тестовой базы. При запуске тестов создается новая пустая база, через которую будет выполняться тестовая выгрузка. Данное имя будет использовано для регистрации базы в списке баз, например "База тестирования переноса истории в git",  
	"git_bare_path": -- путь к git, который в тесте используется как удаленный для выполнения git push, например "C:\\projects\\StorageToGit\\tests\\test data\\bare\\conf_src",  
	"bd_creating_timeout": -- таймаут создания тестовой базы данных, например 60  
}
